<!-- core/templates/core/reportes.html -->
{% extends 'core/base.html' %}
{% load static %}
{% load format_filters %}
{% block content %}
<h3 class="text-center mb-4">Reportes</h3>

<form method="get" class="row g-3 mb-4">
  <div class="col-md-4">
    <label for="start_date" class="form-label">Fecha inicio</label>
    <input type="date" class="form-control" name="start_date" ... value="{{ start_date }}">
  </div>
  <div class="col-md-4">
    <label for="end_date" class="form-label">Fecha fin</label>
    <input type="date" class="form-control" name="end_date" ... value="{{ end_date }}">
  </div>
  <div class="col-md-4 d-flex align-items-end">
    <button type="submit" class="btn btn-primary w-100">Filtrar</button>
  </div>
</form>

{% if not data %}
  <div class="alert alert-info">No hay ventas registradas para el rango seleccionado.</div>
{% endif %}

<div id="ventasChart" style="height: 400px;"></div>
<!-- Tabla descriptiva de la grÃ¡fica -->
<div class="card mt-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Detalle de ventas por vendedor</h5>
      <span class="badge bg-dark">
        Total general: ${{ total_general|format_colombian }} COP
      </span>
    </div>

    {% if rows %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th>Vendedor</th>
              <th class="text-end">Total (COP)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ r.vendedor }}</td>
                <td class="text-end">${{ r.total|format_colombian }}</td>
              </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <th colspan="2" class="text-end">Total general</th>
              <th class="text-end">${{ total_general|format_colombian }}</th>
            </tr>
          </tfoot>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info mb-0">No hay datos para el rango seleccionado.</div>
    {% endif %}
  </div>
</div>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    Highcharts.chart('ventasChart', {
      chart: {
        type: 'column'
      },
      title: {
        text: 'Ventas por Vendedor'
      },
      xAxis: {
        categories: {{ labels|safe }},
        title: { text: 'Vendedores' }
      },
      yAxis: {
        min: 0,
        title: { text: 'Total Vendido (COP)' }
      },
      tooltip: {
        valuePrefix: '$ '
      },
      series: [{
        name: 'Ventas',
        data: {{ data|safe }}
      }]
    });
  });
</script>
{% endblock %}
