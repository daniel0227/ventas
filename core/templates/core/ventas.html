<!-- core/templates/core/crear_venta.html -->
{% extends "core/base.html" %}
{% load static %}

{% block content %}

  <section class="ventas-shell">
    <header class="ventas-header text-center mb-3 mb-md-4">
      <h3 class="ventas-title mb-1">Registrar Ventas</h3>
      <p class="ventas-subtitle mb-0">Crea jugadas de forma rapida y clara.</p>
    </header>
  
  <!-- Toast Container (Mensaje de √©xito) -->
  <div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <div id="toastSuccess" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          ¬°La venta se guard√≥ correctamente!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>
  
  <form id="ventas-form" method="post" class="needs-validation ventas-form" novalidate>
    {% csrf_token %}
  
    <!-- Selecci√≥n de Loter√≠as -->
    {% if loterias %}
      <section class="ventas-card mb-3">
      <div class="section-head">
        <h4 class="section-title mb-0">Loterias</h4>
      </div>
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle w-100" type="button" 
                id="lotteryDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
          Seleccionar Loter√≠as ({{ loterias_seleccionadas.count }})
        </button>
        <div class="dropdown-menu p-2 lottery-menu"
     aria-labelledby="lotteryDropdown"
     id="lotteriesContainer">
  {% for loteria in loterias %}
    <div class="dropdown-item lottery-option"
         data-fin="{{ loteria.hora_fin|time:'H:i' }}">
      <input class="lottery-option-input"
             type="checkbox"
             name="loterias"
             value="{{ loteria.id }}"
             id="loteria-{{ loteria.id }}"
             data-name="{{ loteria.nombre }}"
             data-close="{{ loteria.hora_fin|time:'H:i' }}"
             {% if not loteria.disponible %} disabled {% endif %}>
             <label class="lottery-option-label"
             for="loteria-{{ loteria.id }}">
              <span class="lottery-item-main">
                <span class="lottery-item-name">{{ loteria.nombre }}</span>
                <span class="lottery-item-meta">
                  <i class="bi bi-clock"></i>
                  Cierra {{ loteria.hora_fin|time:"H:i" }}
                </span>
              </span>
              {% if loteria.disponible %}
                <span class="lottery-item-state badge bg-success">Disponible</span>
              {% else %}
                <span class="lottery-item-state badge bg-secondary">Cerrada</span>
              {% endif %}
      </label>
      
    </div>
  {% endfor %}
</div>
      </div>
      <div id="selected-lotteries" class="mt-3 selected-lotteries-wrap">
        <!-- Aqu√≠ se mostrar√°n las loter√≠as seleccionadas -->
      </div>
      </section>
    {% else %}
      <p class="text-danger">No hay loter√≠as disponibles para el d√≠a y hora actuales.</p>
    {% endif %}
  
    <!-- Detalles de la Venta -->
    <section class="ventas-card">
    <div class="section-head">
      <h4 class="section-title mb-0">Detalles de la Venta</h4>
    </div>
    <div class="table-responsive">
      <table id="dynamic-table" class="table table-bordered table-striped ventas-table">
        <thead class="table-dark">
          <tr>
            <th style="text-align: center;">N√∫mero</th>
            <th style="text-align: center;">Combi</th>
            <th style="text-align: center;">Monto</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {# Se generan 5 filas por defecto #}
          {% for i in "12345"|make_list %}
            <tr>
              <td><input type="number" name="numero" class="form-control"></td>
              <td><input type="number" name="combi" class="form-control combi"></td>
              <td><input type="number" name="monto" class="form-control monto"></td>
              <td>
                <button type="button" class="btn btn-danger btn-sm remove-row">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="d-flex justify-content-between mt-3 ventas-actions">
        <button type="button" id="add-row" class="btn btn-success btn-add-row">
          <i class="bi bi-plus-circle"></i> Agregar Fila
        </button>
        <button type="submit" class="btn btn-primary btn-save d-none d-md-inline-flex">
          <i class="bi bi-save"></i> Guardar
        </button>
      </div>
    </div>
    </section>
  
    <!-- Total Din√°mico -->
    <div class="mt-3 mt-md-4 total-wrap d-none d-md-block">
      <h5 class="text-end total-inline">
        Total: 
        <input type="text" id="total-monto" class="form-control d-inline-block w-auto text-end" value="0" readonly>
      </h5>
    </div>
    <div class="mobile-submit-bar d-md-none">
      <div class="mobile-total-block">
        <span class="mobile-total-label">Total</span>
        <span id="mobile-total-monto" class="mobile-total-value">$0</span>
      </div>
      <button type="submit" class="btn btn-primary mobile-save-btn">
        <i class="bi bi-save me-1"></i> Guardar
      </button>
    </div>
<!-- Overlay de procesamiento (solo DISPLAY: none al cargar) -->
<div id="processingOverlay" style="
    display: none;               /* oculto al inicio */
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.9);
    z-index: 2000;
    /* las siguientes no declaran DISPLAY */
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: 1rem;
">
  <!-- Loader -->
  <div id="loaderContainer" style="display: flex; flex-direction: column; align-items: center; z-index: 2001;">
    <img src="{% static 'core/img/loader.gif' %}" alt="Cargando‚Ä¶" style="width: 80px; height: 80px;">
    <div style="font-size: 1.1rem;">Realizando apuesta‚Ä¶</div>
  </div>
  <!-- Mensaje de √©xito -->
  <div id="successContainer" style="
      display: none;
      flex-direction: column;
      align-items: center;
      color: #28a745;
      z-index: 2001;               /* por si acaso */
  ">
    <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
    <div style="font-size: 1.2rem; font-weight: bold;">
      ¬°Apuesta realizada con √©xito!
    </div>
  </div>
</div>
<!-- Bot√≥n flotante de WhatsApp -->
<a id="btnCompartirWhatsApp"
   class="btn-whatsapp-central d-none"
   target="_blank">
  üì§ Compartir por WhatsApp
</a>
  </form>
  </section>
  
  <!-- Modal de Detalle de la Venta -->
  <div class="modal fade" id="saleDetailModal" tabindex="-1" aria-labelledby="saleDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content">
        <!-- Encabezado del modal -->
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title d-flex align-items-center" id="saleDetailModalLabel" style="gap: 8px;">
            <i class="bi bi-receipt" style="font-size: 1.3rem;"></i>
            Resumen de venta <span role="img" aria-label="celebration">üéâ</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <!-- Cuerpo del modal -->
        <div class="modal-body">
          <p class="text-muted mb-3">
            Por favor, aseg√∫rese que los datos han sido ingresados correctamente.
          </p>
  
          <!-- Informaci√≥n b√°sica en tabla -->
          <div class="table-responsive mb-3">
            <table class="table table-sm table-bordered align-middle">
              <tbody>
                <tr>
                  <th scope="row" style="width: 30%;">D√≠a:</th>
                  <td id="saleDay"></td>
                </tr>
                <tr>
                  <th scope="row">Loter√≠as:</th>
                  <td><span id="saleLoteriasList"></span></td>
                </tr>
              </tbody>
            </table>
          </div>
  
          <!-- Tabla de detalles -->
          <div class="table-responsive">
            <table class="table table-sm table-bordered table-striped align-middle">
              <thead class="table-light">
                <tr style="text-align: center;">
                  <th>Detalle</th>
                  <th>Valor</th>
                  <th>Comb</th>
                </tr>
              </thead>
              <tbody id="saleDetailsList">
                <!-- Filas generadas din√°micamente -->
              </tbody>
            </table>
          </div>
  
          <!-- Total -->
          <div class="text-end mt-3">
            <strong>Total:</strong>
            <span id="saleTotalAmount" class="fw-bold"></span>
          </div>
        </div>
  
        <!-- Pie del modal -->
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Descartar</button>
          <button type="button" class="btn btn-primary" id="confirmSaleButton">Apostar</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    :root {
      --ventas-bg: #f8fafc;
      --ventas-surface: #ffffff;
      --ventas-border: #e2e8f0;
      --ventas-text: #0f172a;
      --ventas-muted: #64748b;
      --ventas-primary: #0ea5e9;
    }

    .ventas-shell {
      max-width: 1040px;
      margin: 0 auto;
    }

    .ventas-title {
      color: var(--ventas-text);
      font-weight: 700;
      font-size: 1.45rem;
    }

    .ventas-subtitle {
      color: var(--ventas-muted);
      font-size: 0.93rem;
    }

    .ventas-card {
      background: var(--ventas-surface);
      border: 1px solid var(--ventas-border);
      border-radius: 14px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.05);
      padding: 0.9rem;
      margin-bottom: 0.9rem;
    }

    .section-head {
      margin-bottom: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-title {
      color: var(--ventas-text);
      font-size: 1rem;
      font-weight: 700;
    }

    #lotteryDropdown {
      background: #f1f5f9;
      color: #0f172a;
      border: 1px solid #cbd5e1;
      font-weight: 600;
      border-radius: 10px;
      padding: 0.62rem 0.8rem;
    }

    #lotteriesContainer {
      width: 100%;
      max-height: 320px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    .dropdown-menu .dropdown-item {
      padding: 0.45rem 0.55rem;
      white-space: normal;
      border-radius: 10px;
      margin-bottom: 0.28rem;
      background: #fff;
      border: 1px solid #edf2f7;
    }

    .dropdown-menu .dropdown-item:hover {
      background: #f8fafc;
      border-color: #e2e8f0;
    }

    .lottery-menu {
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      padding: 0.35rem !important;
      border-radius: 12px;
    }

    /* Override global theme rule: .dropdown-menu span { width: 30px; } */
    #lotteriesContainer span {
      width: auto;
    }

    #lotteriesContainer .lottery-item-main {
      width: 100%;
    }

    .lottery-option {
      margin: 0 0 0.35rem 0;
      display: grid !important;
      grid-template-columns: 1.1rem minmax(0, 1fr);
      align-items: start;
      gap: 0.58rem;
      padding: 0.56rem 0.6rem;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: #fff;
      white-space: normal;
      transition: border-color 0.15s ease, background-color 0.15s ease;
    }

    .lottery-option:last-child {
      margin-bottom: 0;
    }

    .lottery-option:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }

    .lottery-option-input {
      width: 1.05rem;
      height: 1.05rem;
      margin: 0.12rem 0 0;
      accent-color: #0ea5e9;
      cursor: pointer;
    }

    .lottery-option-label {
      width: 100%;
      margin: 0;
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      align-items: center;
      gap: 0.5rem;
      line-height: 1.2;
      cursor: pointer;
      min-width: 0;
    }

    .lottery-item-main {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      flex: 1 1 auto;
      justify-self: stretch;
    }

    .lottery-item-name {
      color: #0f172a;
      font-weight: 700;
      font-size: 0.95rem;
      line-height: 1.15;
      word-break: normal;
      overflow-wrap: break-word;
    }

    .lottery-item-meta {
      color: #64748b;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .lottery-item-state {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 22px;
      border-radius: 999px;
      font-size: 0.69rem;
      font-weight: 700;
      padding: 0.16rem 0.52rem;
      white-space: nowrap;
    }

    .lottery-option-input:checked + .lottery-option-label {
      background: #eff6ff;
      border-radius: 10px;
      padding: 0.22rem 0.3rem 0.22rem 0.22rem;
      margin: -0.22rem -0.3rem -0.22rem -0.22rem;
    }

    .lottery-option-input:disabled {
      cursor: not-allowed;
      opacity: 0.65;
    }

    .lottery-option-input:disabled + .lottery-option-label {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .dropdown-toggle::after {
      vertical-align: middle;
    }

    .selected-lotteries-wrap h6 {
      color: var(--ventas-muted);
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.45rem;
    }

    .badge-lottery {
      background: #dcfce7;
      color: #14532d;
      border-radius: 999px;
      padding: 0.26rem 0.6rem;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border: 1px solid #bbf7d0;
      margin-bottom: 0.35rem;
    }
    
    .badge-lottery .remove-lottery-icon {
      cursor: pointer;
      color: #b91c1c;
    }

    .ventas-table thead th {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .ventas-table td {
      vertical-align: middle;
    }

    .ventas-table input.form-control {
      min-height: 38px;
      border-radius: 8px;
      border-color: #dbe2ea;
    }

    .btn-add-row,
    .btn-save {
      border-radius: 10px;
      font-weight: 600;
      padding: 0.55rem 0.95rem;
    }

    .total-inline {
      color: var(--ventas-text);
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 0;
    }

    #total-monto {
      border-radius: 9px;
      border-color: #cbd5e1;
      font-weight: 700;
      color: #0f172a;
      font-size: 0.96rem;
    }

    .mobile-submit-bar {
      position: sticky;
      bottom: 10px;
      z-index: 1030;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.55rem;
      padding: 0.55rem 0.65rem;
      border: 1px solid #dbeafe;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.14);
      backdrop-filter: blur(5px);
      margin-top: 0.75rem;
    }

    .mobile-total-block {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }

    .mobile-total-label {
      font-size: 0.74rem;
      color: var(--ventas-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .mobile-total-value {
      font-size: 0.95rem;
      font-weight: 700;
      color: #0f172a;
    }

    .mobile-save-btn {
      border-radius: 10px;
      font-weight: 700;
      padding: 0.5rem 0.82rem;
      white-space: nowrap;
    }

    .btn-whatsapp-central {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #25D366;
      color: white;
      font-weight: 700;
      border-radius: 999px;
      padding: 12px 20px;
      font-size: 16px;
      z-index: 3000;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
      text-align: center;
      text-decoration: none;
      transition: transform 0.2s ease-in-out;
    }

    .btn-whatsapp-central:hover {
      transform: translateX(-50%) scale(1.04);
    }

    @media (min-width: 768px) {
      .ventas-card {
        padding: 1rem 1.1rem;
      }

      .mobile-submit-bar {
        display: none !important;
      }
    }

    @media (max-width: 575.98px) {
      .ventas-title {
        font-size: 1.2rem;
      }

      .ventas-subtitle {
        font-size: 0.84rem;
      }

      .ventas-card {
        padding: 0.7rem;
        border-radius: 12px;
      }

      .ventas-table thead th {
        font-size: 0.72rem;
      }

      .ventas-actions {
        margin-bottom: 0.2rem;
      }

      .lottery-option-input {
        width: 1rem;
        height: 1rem;
        margin-top: 0.14rem;
      }

      .lottery-option-label {
        gap: 0.44rem;
      }

      .lottery-item-name {
        font-size: 0.92rem;
      }

      .lottery-item-meta {
        font-size: 0.74rem;
      }

      .lottery-item-state {
        font-size: 0.66rem;
        padding: 0.16rem 0.42rem;
      }
    }
  </style>
  
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const container = document.getElementById('lotteriesContainer');
      if (!container) return;
    
      // Obtener todos los dropdown-item y ordenarlos por data-fin (HH:MM) ascendente
      const items = Array.from(container.querySelectorAll('.dropdown-item'));
      items.sort((a, b) => a.dataset.fin.localeCompare(b.dataset.fin));
    
      // Volver a insertarlos en orden
      items.forEach(item => container.appendChild(item));
    });
    </script>

  <script>
    (function() {
      'use strict';

      function construirMensajeWhatsapp(resumen) {
  const { codigo, vendedor, loterias, jugadas, total } = resumen;

  const ahora = new Date();
  const fechaFormateada = ahora.toLocaleString('es-CO', {
    day: '2-digit',
    month: 'long',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  }).replace(',', ' -');

  let mensaje = `${fechaFormateada}\n\n`;
  mensaje += `*C√≥digo:* ${codigo}\n`;
  mensaje += `*Loter√≠as:* ${loterias.join(', ')}\n\n`;
  mensaje += `*Apuesta:*\n`;

  jugadas.forEach(j => {
    const valor = j.numero || j.combi || 'N/A';
    const monto = `$${j.monto.toLocaleString('es-CO')}`;
    mensaje += `‚Ä¢ ${valor} - ${monto}\n`;
  });

  mensaje += `\nüí∞ *Total:* $${total.toLocaleString('es-CO')}`;
  return encodeURIComponent(mensaje);
}

  
      // Funci√≥n para actualizar el total del formulario: S√ìLO se suman los montos (campo "monto")
      function updateTotal() {
        const rows = document.querySelectorAll('#dynamic-table tbody tr');
        const loteriasSeleccionadas = document.querySelectorAll('input[name="loterias"]:checked');
        let total = 0;
        rows.forEach(function(row) {
          const montoVal = parseFloat(row.querySelector('input[name="monto"]').value) || 0;
          total += montoVal;
        });
        total *= loteriasSeleccionadas.length;
        document.getElementById('total-monto').value = total.toLocaleString('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0
        });
        const mobileTotal = document.getElementById('mobile-total-monto');
        if (mobileTotal) {
          mobileTotal.textContent = total.toLocaleString('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
          });
        }
      }
  
      // Funci√≥n para actualizar la visualizaci√≥n de loter√≠as seleccionadas
      function updateSelectedLotteries() {
        const selected = document.querySelectorAll('input[name="loterias"]:checked');
        const container = document.getElementById('selected-lotteries');
        const button = document.getElementById('lotteryDropdown');
      
        button.textContent = `Seleccionar Loter√≠as (${selected.length})`;
        container.innerHTML = selected.length > 0 ? '<h6 class="mb-2">Loter√≠as seleccionadas:</h6>' : '';
      
        selected.forEach(function(loteria) {
          const lotteryName = loteria.dataset.name || loteria.parentNode.querySelector('label').textContent.trim();
          container.innerHTML += `
            <span class="badge-lottery me-1 mb-1" data-loteria-id="${loteria.value}">
              ${lotteryName}
              <i class="bi bi-x-circle remove-lottery-icon" role="button" aria-label="Quitar loteria"></i>
            </span>
          `;
        });
      
        container.querySelectorAll('.remove-lottery-icon').forEach(function(icon) {
          icon.addEventListener('click', function() {
            const text = icon.parentNode.textContent.trim();
            document.querySelectorAll('input[name="loterias"]').forEach(function(checkbox) {
              if (checkbox.parentNode.textContent.trim() === text) {
                checkbox.click();
              }
            });
          });
        });
      }
  
      // Asignar eventos a los checkboxes de loter√≠as
      document.querySelectorAll('input[name="loterias"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          updateSelectedLotteries();
          updateTotal();
        });
      });
  
      // Delegaci√≥n para eliminar filas de la tabla
      document.getElementById('dynamic-table').addEventListener('click', function(e) {
        if (e.target.closest('.remove-row')) {
          e.target.closest('tr').remove();
          updateTotal();
        }
      });
  
      // Asigna listeners a los campos "monto" y "combi" en cada fila
      function attachRowListeners(row) {
        const montoInput = row.querySelector('.monto');
        if (montoInput) {
          montoInput.addEventListener('input', updateTotal);
        }
        const combiInput = row.querySelector('.combi');
        if (combiInput) {
          combiInput.addEventListener('input', function() {
            // No se llama updateTotal ya que combi no afecta el total
          });
        }
      }
  
      // Inicializa filas existentes y actualiza total y loter√≠as seleccionadas
      document.querySelectorAll('#dynamic-table tbody tr').forEach(function(row) {
        attachRowListeners(row);
      });
      updateTotal();
      updateSelectedLotteries();
  
      // Agregar nueva fila
      document.getElementById('add-row').addEventListener('click', function() {
        const tbody = document.querySelector('#dynamic-table tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td><input type="number" name="numero" class="form-control"></td>
          <td><input type="number" name="combi" class="form-control combi"></td>
          <td><input type="number" name="monto" class="form-control monto"></td>
          <td>
            <button type="button" class="btn btn-danger btn-sm remove-row">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(newRow);
        attachRowListeners(newRow);
        updateTotal();
      });
  
      // Manejo del submit del formulario
      document.getElementById('ventas-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = e.target;
        const selectedLotteries = document.querySelectorAll('input[name="loterias"]:checked');
  
        if (selectedLotteries.length === 0) {
          alert("Debe seleccionar al menos una loter√≠a.");
          return;
        }
  
        // Validar filas
let rows = Array.from(document.querySelectorAll('#dynamic-table tbody tr'));
let incompleteFound = false;
let validRowExists  = false;

rows.forEach(function(row) {
  const numero = row.querySelector('input[name="numero"]').value.trim();
  const combi  = row.querySelector('input[name="combi"]').value.trim();
  const monto  = row.querySelector('input[name="monto"]').value.trim();

  // Fila completamente vac√≠a ‚Üí se descarta
  if (numero === '' && combi === '' && monto === '') {
    row.remove();
    return;
  }

  // Reglas: monto obligatorio Y (numero || combi)
  if (monto === '' || (numero === '' && combi === '')) {
    incompleteFound = true;
  } else {
    validRowExists = true;
  }
});

if (incompleteFound) {
  alert("Cada fila debe tener Monto y al menos N√∫mero o Combi.");
  return;
}
if (!validRowExists) {
  alert("Debe completar al menos una fila con datos v√°lidos.");
  return;
}
  
        // Llenar el modal con los datos
        const saleLoteriasList = document.getElementById('saleLoteriasList');
        saleLoteriasList.innerHTML = '';
        selectedLotteries.forEach(function(loteria) {
          const li = document.createElement('li');
          li.textContent = loteria.parentNode.querySelector('label').textContent.trim();
          saleLoteriasList.appendChild(li);
        });
  
        const saleDetailsList = document.getElementById('saleDetailsList');
        saleDetailsList.innerHTML = '';
        document.querySelectorAll('#dynamic-table tbody tr').forEach(function(row) {
          const numero = row.querySelector('input[name="numero"]').value.trim();
          const monto = row.querySelector('input[name="monto"]').value.trim();
          const combi = row.querySelector('input[name="combi"]').value.trim() || 'N/A';
          const parsedMonto = parseFloat(monto) || 0;
          const formattedMonto = parsedMonto.toLocaleString('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
          });
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${numero}</td><td>${formattedMonto}</td><td>${combi}</td>`;
          saleDetailsList.appendChild(tr);
        });
  
        // Calcular total para el modal (solo se suman los montos)
        let total = 0;
        document.querySelectorAll('.monto').forEach(function(input) {
          total += parseFloat(input.value) || 0;
        });
        total *= selectedLotteries.length;
        document.getElementById('saleTotalAmount').textContent = total.toLocaleString('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0
        });
  
        // Actualizar fecha/hora din√°mica en el modal
        const saleDayElement = document.getElementById('saleDay');
        const now = new Date();
        const options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        };
        saleDayElement.textContent = now.toLocaleString('es-CO', options);
  
        // Mostrar modal de detalle
        const saleDetailModal = new bootstrap.Modal(document.getElementById('saleDetailModal'));
        saleDetailModal.show();
  
        // Asignar evento de confirmaci√≥n (una sola vez)
const confirmButton = document.getElementById('confirmSaleButton');
const newConfirmButton = confirmButton.cloneNode(true);
confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);

newConfirmButton.addEventListener('click', function() {
  // 1) Mostrar overlay y deshabilitar bot√≥n
  const overlay = document.getElementById('processingOverlay');
  overlay.style.display = 'flex';
  newConfirmButton.disabled = true;
  newConfirmButton.textContent = 'Enviando‚Ä¶';

  // 2) Realizar el env√≠o
  const formData = new FormData(form);
  fetch(form.action || window.location.href, {
    method: 'POST',
    headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      alert(data.error);
      // reactiva bot√≥n y oculta overlay
      newConfirmButton.disabled = false;
      newConfirmButton.textContent = 'Apostar';
      overlay.style.display = 'none';
      return;
    }
    // √©xito: cerrar modal, mostrar toast y recargar
    saleDetailModal.hide();
    new bootstrap.Toast(document.getElementById('toastSuccess'), { delay:2000 }).show();
    setTimeout(() => window.location.reload(), 4000);
    // Mostrar bot√≥n de WhatsApp
if (data.resumen_venta) {
  const mensaje = construirMensajeWhatsapp(data.resumen_venta);
  const btnWhatsApp = document.getElementById('btnCompartirWhatsApp');
  btnWhatsApp.href = `https://wa.me/?text=${mensaje}`;
  btnWhatsApp.classList.remove('d-none');
}
setTimeout(() => window.location.reload(), 2000);
  })
  
  .catch(error => {
    console.error('Error en el env√≠o:', error);
    alert('Ocurri√≥ un error al enviar la venta.');
    // reactiva bot√≥n y oculta overlay
    newConfirmButton.disabled = false;
    newConfirmButton.textContent = 'Apostar';
    overlay.style.display = 'none';
  });
});

      });
    })();
  </script>
  
{% endblock %}




