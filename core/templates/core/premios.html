{% extends "core/base.html" %}
{% load static %}
{% load format_filters %}

{% block content %}
<main class="container px-3 py-4">

  <!-- Título compacto -->
  <header class="mb-2">
    <h1 class="h5 text-center mb-0">Premios para {{ fecha }}</h1>
  </header>

  <!-- Filtro de fecha (sticky + input-group alineado) -->
  <div class="position-sticky top-0 bg-body z-3 py-2 mb-3 border-bottom sticky-filter">
    <form method="get" class="mb-0" role="search" aria-label="Filtrar por fecha">
      <label for="fecha" class="form-label mb-1">Seleccionar fecha</label>
      <div class="input-group filter-group">
        <input
          type="date"
          id="fecha"
          name="fecha"
          class="form-control"
          value="{{ fecha_actual|date:'Y-m-d'|default:'' }}"
          max="{{ fecha_actual|date:'Y-m-d' }}"
          aria-label="Seleccionar fecha">
        <button type="submit" class="btn btn-outline-secondary">Filtrar</button>
      </div>
    </form>
  </div>

  {% if premios_list %}

    {# ===== Resumen de totales (píldoras con ícono) ===== #}
    <section class="mb-3" aria-label="Resumen de premios del día">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="summary-pill summary-green">
          <!-- trophy -->
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" class="me-1">
            <path d="M18 4h2a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1a5 5 0 0 1-5-5V4h7Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M6 4H4a2 2 0 0 0-2 2v1a5 5 0 0 0 5 5h1" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 14v5M8 21h8" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
          <strong>Total:</strong> ${{ total_premios|default:0|format_colombian }}
        </span>

        <span class="summary-pill summary-amber">
          <!-- hashtag -->
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" class="me-1">
            <path d="M4 9h16M3 15h16M9 4l-2 16M17 4l-2 16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
          <strong>Cantidad:</strong> {{ premios_list|length }}
        </span>
      </div>
    </section>

    {# ===== Vista móvil: tarjetas (XS–SM) ===== #}
    <section class="d-md-none" aria-label="Listado de premios">
      <ul class="list-unstyled m-0">
        {% for premio in premios_list %}
          <li class="card premio-item mb-2 shadow-sm">

            <div class="premio-logo">
              {% if premio.imagen %}
                <img
                  src="{{ premio.imagen.url }}"
                  {% if premio.imagen_2x %}srcset="{{ premio.imagen.url }} 1x, {{ premio.imagen_2x.url }} 2x"{% endif %}
                  alt="Logo {{ premio.nombre }}"
                  width="56" height="56"
                  loading="lazy" decoding="async">
              {% else %}
                <img
                  src="{% static 'core/img/default-loteria.png' %}"
                  alt="Logo por defecto"
                  width="56" height="56"
                  loading="lazy" decoding="async">
              {% endif %}
            </div>

            <div class="premio-info">
              <h3 class="premio-title h6 mb-1">{{ premio.nombre }}</h3>

              <div class="premio-meta small">
                <span class="chip-numero">Nº {{ premio.numero_ganador }}</span>
                {% if es_admin %}
                  <span class="vendedor">
                    <span class="vendedor-label">Vendedor:</span>
                    <span class="vendedor-nombre">
                      {{ premio.vendedor.get_full_name|default:premio.vendedor.username|title }}
                    </span>
                  </span>
                {% endif %}
              </div>
            </div>

            {# Columna derecha: valor + botón compartir #}
            <div class="premio-right">
              <div class="premio-valor fw-semibold text-nowrap">
                ${{ premio.valor|format_colombian }}
              </div>

              <button type="button"
                class="btn btn-icon-outline share-btn"
                aria-label="Compartir por WhatsApp"
                title="Compartir por WhatsApp"
                data-share-text="🎉 *Premio confirmado*&#10;&#10;🏆 *{{ premio.nombre }}*&#10;🔢 Número ganador: *{{ premio.numero_ganador }}*&#10;💰 Valor: *${{ premio.valor|format_colombian }} COP*&#10;📅 {{ fecha }}{% if es_admin %}&#10;👤 Vendedor: {{ premio.vendedor.get_full_name|default:premio.vendedor.username|title }}{% endif %}">
                <!-- WhatsApp outline -->
                <svg class="icon-wa-outline" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
                  <path d="M7.2 17.4L6 19l1.9-.6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M15.8 14.2l-.8 1.3c-.2.3-.6.4-1 .3c-1-.3-2.2-.9-3.2-1.9s-1.6-2.2-1.9-3.2c-.1-.4 0-.8.3-1l1.3-.8M10.5 9.1l1.6.9c.4.2.6.7.4 1.1l-.4.7c.7.4 1.3.7 2 .9l.7-.4c.4-.2.9 0 1.1.4l.9 1.6"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>

          </li>
        {% endfor %}
      </ul>
    </section>

    {# ===== Vista tablet/escritorio: tabla (≥ md) ===== #}
    <section class="d-none d-md-block">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col">Imagen</th>
              <th scope="col">Lotería</th>
              <th scope="col">Número</th>
              <th scope="col" class="text-end">Valor</th>
              {% if es_admin %}
                <th scope="col">Vendedor</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for premio in premios_list %}
              <tr>
                <td>
                  {% if premio.imagen %}
                    <img
                      src="{{ premio.imagen.url }}"
                      {% if premio.imagen_2x %}srcset="{{ premio.imagen.url }} 1x, {{ premio.imagen_2x.url }} 2x"{% endif %}
                      alt="Logo {{ premio.nombre }}"
                      class="rounded-2 object-fit-cover"
                      width="65" height="65"
                      loading="lazy" decoding="async">
                  {% else %}
                    <img
                      src="{% static 'core/img/default-loteria.png' %}"
                      alt="Logo por defecto"
                      class="rounded-2 object-fit-cover"
                      width="65" height="65"
                      loading="lazy" decoding="async">
                  {% endif %}
                </td>
                <td class="fw-semibold">{{ premio.nombre }}</td>
                <td>Nº {{ premio.numero_ganador }}</td>
                <td class="text-end valor-tabla">${{ premio.valor|format_colombian }}</td>
                {% if es_admin %}
                  <td>{{ premio.vendedor.get_full_name|default:premio.vendedor.username|title }}</td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>

          {# ===== Total en pie de tabla ===== #}
          <tfoot>
            <tr>
              <th colspan="3" class="text-end">Total premios</th>
              <th class="text-end">${{ total_premios|default:0|format_colombian }}</th>
              {% if es_admin %}<th></th>{% endif %}
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

  {% else %}
    <div class="alert alert-info" role="status" aria-live="polite">
      No se han registrado premios para la fecha {{ fecha }}.
    </div>
  {% endif %}

</main>

<style>
  :root { --wa: #22c55e; }

  /* ===== Píldoras resumen ===== */
  .summary-pill{
    display:inline-flex; align-items:center; gap:.35rem;
    padding:.35rem .65rem; border-radius:999px; font-weight:600;
    line-height:1; font-size: .98rem; white-space:nowrap;
  }
  .summary-green{
    color:#0f5132; background:#d1e7dd; border:1px solid #badbcc;
  }
  .summary-amber{
    color:#664d03; background:#fff3cd; border:1px solid #ffecb5;
  }

  .btn-icon-outline{
    width:44px; height:44px; padding:0;
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:.75rem;
    border:2px solid var(--wa);
    color:var(--wa);
    background:transparent;
    line-height:1;
  }
  .btn-icon-outline:hover,
  .btn-icon-outline:focus{
    background: color-mix(in srgb, var(--wa) 8%, transparent);
    outline: none;
  }
  .btn-icon-outline:active{ transform: scale(.98); }

  .icon-wa-outline{
    width:22px; height:22px;
    display:block;
    filter: drop-shadow(0 0 .5px rgba(0,0,0,.15));
  }

  .sticky-filter{ padding-top: max(.25rem, env(safe-area-inset-top)); }
  .filter-group > .form-control, .filter-group > .btn { height: 40px; }
  .filter-group > .btn { line-height: 1; }
  input[type="date"], .btn { min-height: 0; }

  .premio-valor, .valor-tabla, .monto, .currency {
    font-variant-numeric: tabular-nums;
    min-width: 7ch;
    text-align: right;
  }

  .premio-item{
    display: grid;
    grid-template-columns: 56px 1fr auto;
    gap: .75rem;
    align-items: center;
    padding: .5rem .9rem .5rem .75rem;
    border-radius: 1rem;
    transition: transform .06s ease, box-shadow .12s ease;
    content-visibility: auto;
    contain-intrinsic-size: 80px;
  }
  .premio-item:active{ transform: scale(.99); box-shadow: 0 0 0 2px rgba(0,0,0,.03) inset; }
  @media (prefers-reduced-motion: reduce){ .premio-item{ transition:none; } }

  .premio-logo img{ border-radius:.5rem; aspect-ratio:1/1; object-fit:cover; display:block; }
  .premio-title{ margin:0; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .premio-meta{
    display:flex; align-items:baseline; flex-wrap:wrap; gap:.5rem;
    line-height:1.15; color:var(--bs-secondary-color);
  }
  .chip-numero{
    display:inline-block; padding:.1rem .5rem; border-radius:999px;
    background:var(--bs-light); border:1px solid var(--bs-border-color);
    font-weight:600; margin-right:.125rem; white-space:nowrap;
  }
  .vendedor{ display:inline-flex; align-items:baseline; gap:.25rem; white-space:nowrap; max-width:55vw; min-width:0; }
  .vendedor-label{ color:var(--bs-secondary-color); }
  .vendedor-nombre{ color:var(--bs-body-color); font-weight:600; display:inline-block; max-width:100%; overflow:hidden; text-overflow:ellipsis; }

  .premio-right{ display:flex; flex-direction:column; align-items:flex-end; gap:.25rem; }
  .btn-icon{
    padding:.25rem; line-height:1; height:32px; width:32px;
    display:inline-flex; align-items:center; justify-content:center; border-radius:.5rem;
  }
</style>

<script>
  // Auto-submit al cambiar la fecha
  document.getElementById('fecha')?.addEventListener('change', e => e.target.form?.submit());

  // Share con Web Share API + fallback a WhatsApp o copiar
  function sharePremio(texto){
    if (navigator.share) { navigator.share({ text: texto }).catch(()=>{}); return; }
    const wa = 'https://wa.me/?text=' + encodeURIComponent(texto);
    /Android|iPhone|iPad/i.test(navigator.userAgent)
      ? window.open(wa, '_blank')
      : (navigator.clipboard?.writeText(texto).then(()=>alert('Texto copiado ✅')));
  }
  document.querySelectorAll('.share-btn').forEach(b =>
    b.addEventListener('click', () => sharePremio(b.dataset.shareText))
  );

  if (window.bootstrap) {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
  }
</script>
{% endblock %}
